"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e};!function(e,t){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"object"===("undefined"==typeof module?"undefined":_typeof(module))?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"===("undefined"==typeof exports?"undefined":_typeof(exports))?exports.WebIM=t():e.WebIM=t()}(void 0,function(){return function(e){function t(n){if(o[n])return o[n].exports;var r=o[n]={exports:{},id:n,loaded:!1};return e[n].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var o={};return t.m=e,t.c=o,t.p="",t(0)}([function(e,t,o){e.exports=o(1)},function(module,exports,__webpack_require__){function _parsePrivacy(e){var t=[],o=e.getElementsByTagName("item");if(o)for(var n=0;n<o.length;n++){var r=o[n],i=r.getAttribute("value"),s=r.getAttribute("order"),a=r.getAttribute("type");if(i){var c=_parseNameFromJidFn(i);t[c]={type:a,order:s,jid:i,name:c}}}return t}function _parseGroupBlacklist(e){var t={},o=e.getElementsByTagName("item");if(o)for(var n=0;n<o.length;n++){var r=o[n],i=r.getAttribute("jid"),s=r.getAttribute("affiliation"),a=r.getAttribute("nick");if(i){var c=_parseNameFromJidFn(i);t[c]={jid:i,affiliation:s,nick:a,name:c}}}return t}function _setText(e,t){"textContent"in e?e.textContent=t:"text"in e&&(e.text=t)}var _version="1.4.2",_code=__webpack_require__(2).code,_utils=__webpack_require__(3).utils,_msg=__webpack_require__(4),_message=_msg._msg,_msgHash={},Queue=__webpack_require__(5).Queue;window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,window.XDomainRequest&&(XDomainRequest.prototype.oldsend=XDomainRequest.prototype.send,XDomainRequest.prototype.send=function(){XDomainRequest.prototype.oldsend.apply(this,arguments),this.readyState=2}),Strophe.Request.prototype._newXHR=function(){var e=_utils.xmlrequest(!0);return e.overrideMimeType&&e.overrideMimeType("text/xml"),e.onreadystatechange=this.func.bind(null,this),e},Strophe.Websocket.prototype._closeSocket=function(){if(this.socket){var e=this;setTimeout(function(){try{e.socket.close()}catch(e){}},0)}else this.socket=null},Strophe.Websocket.prototype._onMessage=function(e){WebIM&&WebIM.config.isDebug&&console.log(WebIM.utils.ts()+"recv:",e.data);var t,o;if(0===e.data.indexOf("<close ")){t=(new DOMParser).parseFromString(e.data,"text/xml").documentElement;var n=t.getAttribute("see-other-uri");return void(n?(this._conn._changeConnectStatus(Strophe.Status.REDIRECT,"Received see-other-uri, resetting connection"),this._conn.reset(),this._conn.service=n,this._connect()):this._conn._doDisconnect("receive <close> from server"))}if(0===e.data.search("<open ")){if(t=(new DOMParser).parseFromString(e.data,"text/xml").documentElement,!this._handleStreamStart(t))return}else o=this._streamWrap(e.data),t=(new DOMParser).parseFromString(o,"text/xml").documentElement;if(!this._check_streamerror(t,Strophe.Status.ERROR))return this._conn.disconnecting&&"presence"===t.firstChild.nodeName&&"unavailable"===t.firstChild.getAttribute("type")?(this._conn.xmlInput(t),void this._conn.rawInput(Strophe.serialize(t))):void this._conn._dataRecv(t,e.data)};var _listenNetwork=function(e,t){window.addEventListener?(window.addEventListener("online",e),window.addEventListener("offline",t)):window.attachEvent&&(document.body?(document.body.attachEvent("ononline",e),document.body.attachEvent("onoffline",t)):window.attachEvent("load",function(){document.body.attachEvent("ononline",e),document.body.attachEvent("onoffline",t)}))},_parseRoom=function(e){var t=[],o=e.getElementsByTagName("item");if(o)for(var n=0;n<o.length;n++){var r=o[n],i=r.getAttribute("jid"),s=i.split("@")[0],a={jid:i,name:r.getAttribute("name"),roomId:s.split("_")[1]};t.push(a)}return t},_parseRoomOccupants=function(e){var t=[],o=e.getElementsByTagName("item");if(o)for(var n=0;n<o.length;n++){var r=o[n],i={jid:r.getAttribute("jid"),name:r.getAttribute("name")};t.push(i)}return t},_parseResponseMessage=function _parseResponseMessage(msginfo){var parseMsgData={errorMsg:!0,data:[]},msgBodies=msginfo.getElementsByTagName("body");if(msgBodies){for(var i=0;i<msgBodies.length;i++){var msgBody=msgBodies[i],childNodes=msgBody.childNodes;if(childNodes&&childNodes.length>0){var childNode=msgBody.childNodes[0];if(childNode.nodeType==Strophe.ElementType.TEXT){var jsondata=childNode.wholeText||childNode.nodeValue;jsondata=jsondata.replace("\n","<br>");try{var data=eval("("+jsondata+")");parseMsgData.errorMsg=!1,parseMsgData.data=[data]}catch(e){}}}}var delayTags=msginfo.getElementsByTagName("delay");if(delayTags&&delayTags.length>0){var delayTag=delayTags[0],delayMsgTime=delayTag.getAttribute("stamp");delayMsgTime&&(parseMsgData.delayTimeStamp=delayMsgTime)}}else{var childrens=msginfo.childNodes;if(childrens&&childrens.length>0){var child=msginfo.childNodes[0];if(child.nodeType==Strophe.ElementType.TEXT)try{var data=eval("("+child.nodeValue+")");parseMsgData.errorMsg=!1,parseMsgData.data=[data]}catch(e){}}}return parseMsgData},_parseNameFromJidFn=function(e,t){t=t||"";var o=e,n=o.indexOf("_");n!==-1&&(o=o.substring(n+1));var r=o.indexOf("@"+t);return r!==-1&&(o=o.substring(0,r)),o},_parseFriend=function(e,t,o){var n=[],r=e.getElementsByTagName("item");if(r)for(var i=0;i<r.length;i++){var s=r[i],a=s.getAttribute("jid");if(a){var c=s.getAttribute("subscription"),p={subscription:c,jid:a},l=s.getAttribute("ask");l&&(p.ask=l);var u=s.getAttribute("name");if(u)p.name=u;else{var d=_parseNameFromJidFn(a);p.name=d}var m=[];Strophe.forEachChild(s,"group",function(e){m.push(Strophe.getText(e))}),p.groups=m,n.push(p),t&&"from"==c&&t.subscribe({toJid:a}),t&&"to"==c&&t.subscribed({toJid:a})}}return n},_login=function(e,t){var o=e.access_token||"";if(""==o){_utils.stringify(e);return void t.onError({type:_code.WEBIM_CONNCTION_OPEN_USERGRID_ERROR,data:e})}t.context.accessToken=e.access_token,t.context.accessTokenExpires=e.expires_in;var n=null;n=t.isOpening()&&t.context.stropheConn?t.context.stropheConn:t.isOpened()&&t.context.stropheConn?t.getStrophe():t.getStrophe();var r=function(e,o){_loginCallback(e,o,t)};t.context.stropheConn=n,t.route?n.connect(t.context.jid,"$t$"+o,r,t.wait,t.hold,t.route):n.connect(t.context.jid,"$t$"+o,r,t.wait,t.hold)},_parseMessageType=function(e){var t="normal",o=e.getElementsByTagName("received");if(o&&o.length>0&&"urn:xmpp:receipts"===o[0].namespaceURI)t="received";else{var n=e.getElementsByTagName("invite");n&&n.length>0&&(t="invite")}return t},_handleMessageQueue=function(e){for(var t in _msgHash)_msgHash.hasOwnProperty(t)&&_msgHash[t].send(e)},_loginCallback=function(e,t,o){var n,r;if("conflict"===t&&(n=!0),e==Strophe.Status.CONNFAIL)r={type:_code.WEBIM_CONNCTION_SERVER_CLOSE_ERROR,msg:t,reconnect:!0},n&&(r.conflict=!0),o.onError(r);else if(e==Strophe.Status.ATTACHED||e==Strophe.Status.CONNECTED){o.autoReconnectNumTotal=0,o.intervalId=setInterval(function(){o.handelSendQueue()},200);var i=function(e){var t=_parseMessageType(e);return"received"===t?(o.handleReceivedMessage(e),!0):"invite"===t?(o.handleInviteMessage(e),!0):(o.handleMessage(e),!0)},s=function(e){return o.handlePresence(e),!0},a=function(e){return o.handlePing(e),!0},c=function(e){return o.handleIqRoster(e),!0},p=function(e){return o.handleIqPrivacy(e),!0},l=function(e){return o.handleIq(e),!0};o.addHandler(i,null,"message",null,null,null),o.addHandler(s,null,"presence",null,null,null),o.addHandler(a,"urn:xmpp:ping","iq","get",null,null),o.addHandler(c,"jabber:iq:roster","iq","set",null,null),o.addHandler(p,"jabber:iq:privacy","iq","set",null,null),o.addHandler(l,null,"iq",null,null,null),o.registerConfrIQHandler&&o.registerConfrIQHandler(),o.context.status=_code.STATUS_OPENED;var u=[_code.WEBIM_MESSAGE_REC_TEXT,_code.WEBIM_MESSAGE_REC_EMOJI];_utils.isCanDownLoadFile&&(u.push(_code.WEBIM_MESSAGE_REC_PHOTO),u.push(_code.WEBIM_MESSAGE_REC_AUDIO_FILE));var d=[_code.WEBIM_MESSAGE_SED_TEXT];_utils.isCanUploadFile&&(d.push(_code.WEBIM_MESSAGE_REC_PHOTO),d.push(_code.WEBIM_MESSAGE_REC_AUDIO_FILE)),o.notifyVersion(),o.retry&&_handleMessageQueue(o),o.heartBeat(),o.isAutoLogin&&o.setPresence(),o.onOpened({canReceive:u,canSend:d,accessToken:o.context.accessToken})}else if(e==Strophe.Status.DISCONNECTING)o.isOpened()&&(o.stopHeartBeat(),o.context.status=_code.STATUS_CLOSING,r={type:_code.WEBIM_CONNCTION_SERVER_CLOSE_ERROR,msg:t,reconnect:!0},n&&(r.conflict=!0),o.onError(r));else if(e==Strophe.Status.DISCONNECTED){if(o.isOpened()){if(o.autoReconnectNumTotal<o.autoReconnectNumMax)return void o.reconnect();r={type:_code.WEBIM_CONNCTION_DISCONNECTED},o.onError(r)}o.context.status=_code.STATUS_CLOSED,o.clear(),o.onClosed()}else e==Strophe.Status.AUTHFAIL?(r={type:_code.WEBIM_CONNCTION_AUTH_ERROR},n&&(r.conflict=!0),o.onError(r),o.clear()):e==Strophe.Status.ERROR&&(o.context.status=_code.STATUS_ERROR,r={type:_code.WEBIM_CONNCTION_SERVER_ERROR},n&&(r.conflict=!0),o.onError(r));o.context.status_now=e},_getJid=function(e,t){var o=e.toJid||"";if(""===o){var n=t.context.appKey||"",r=n+"_"+e.to+"@"+t.domain;e.resource&&(r=r+"/"+e.resource),o=r}return o},_getJidByName=function(e,t){var o={to:e};return _getJid(o,t)},_validCheck=function(e,t){if(e=e||{},""==e.user)return t.onError({type:_code.WEBIM_CONNCTION_USER_NOT_ASSIGN_ERROR}),!1;var o=e.user+""||"",n=e.appKey||"",r=n.split("#");if(2!==r.length)return t.onError({type:_code.WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR}),!1;var i=r[0],s=r[1];if(!i)return t.onError({type:_code.WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR}),!1;if(!s)return t.onError({type:_code.WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR}),!1;var a=n+"_"+o.toLowerCase()+"@"+t.domain,c=e.resource||"webim";return t.isMultiLoginSessions&&(c+=o+(new Date).getTime()+Math.floor(1e6*Math.random().toFixed(6))),t.context.jid=a+"/"+c,t.context.userId=o,t.context.appKey=n,t.context.appName=s,t.context.orgName=i,!0},_getXmppUrl=function(e,t){if(/^(ws|http)s?:\/\/?/.test(e))return e;var o={prefix:"http",base:"://"+e,suffix:"/http-bind/"};return t&&_utils.isSupportWss?(o.prefix="wss",o.suffix="/ws/"):t?o.prefix="https":window.WebSocket&&(o.prefix="ws",o.suffix="/ws/"),o.prefix+o.base+o.suffix},connection=function e(t){if(!this instanceof e)return new e(t);var t=t||{};this.isHttpDNS=t.isHttpDNS||!1,this.isMultiLoginSessions=t.isMultiLoginSessions||!1,this.wait=t.wait||30,this.retry=t.retry||!1,this.https=t.https||"https:"===location.protocol,this.url=_getXmppUrl(t.url,this.https),this.hold=t.hold||1,this.route=t.route||null,this.domain=t.domain||"easemob.com",this.inactivity=t.inactivity||30,this.heartBeatWait=t.heartBeatWait||4500,this.maxRetries=t.maxRetries||5,this.isAutoLogin=t.isAutoLogin!==!1,this.pollingTime=t.pollingTime||800,this.stropheConn=!1,this.autoReconnectNumMax=t.autoReconnectNumMax||0,this.autoReconnectNumTotal=0,this.autoReconnectInterval=t.autoReconnectInterval||0,this.context={status:_code.STATUS_INIT},this.sendQueue=new Queue,this.intervalId=null,this.apiUrl=t.apiUrl||"",this.isWindowSDK=t.isWindowSDK||!1,this.dnsArr=["https://rs.easemob.com","https://rsbak.easemob.com","http://182.92.174.78","http://112.126.66.111"],this.dnsIndex=0,this.dnsTotal=this.dnsArr.length,this.restHosts=null,this.restIndex=0,this.restTotal=0,this.xmppHosts=null,this.xmppIndex=0,this.xmppTotal=0,this.groupOption={}};connection.prototype.registerUser=function(e){"https:"!=location.protocol&&this.isHttpDNS?(this.dnsIndex=0,this.getHttpDNS(e,"signup")):this.signup(e)},connection.prototype.handelSendQueue=function(){var e=this.sendQueue.pop();null!==e&&this.sendReceiptsMessage(e)},connection.prototype.listen=function(e){this.onOpened=e.onOpened||_utils.emptyfn,this.onClosed=e.onClosed||_utils.emptyfn,this.onTextMessage=e.onTextMessage||_utils.emptyfn,this.onEmojiMessage=e.onEmojiMessage||_utils.emptyfn,this.onPictureMessage=e.onPictureMessage||_utils.emptyfn,this.onAudioMessage=e.onAudioMessage||_utils.emptyfn,this.onVideoMessage=e.onVideoMessage||_utils.emptyfn,this.onFileMessage=e.onFileMessage||_utils.emptyfn,this.onLocationMessage=e.onLocationMessage||_utils.emptyfn,this.onCmdMessage=e.onCmdMessage||_utils.emptyfn,this.onPresence=e.onPresence||_utils.emptyfn,this.onRoster=e.onRoster||_utils.emptyfn,this.onError=e.onError||_utils.emptyfn,this.onReceivedMessage=e.onReceivedMessage||_utils.emptyfn,this.onInviteMessage=e.onInviteMessage||_utils.emptyfn,this.onOffline=e.onOffline||_utils.emptyfn,this.onOnline=e.onOnline||_utils.emptyfn,this.onConfirmPop=e.onConfirmPop||_utils.emptyfn,this.onUpdateMyGroupList=e.onUpdateMyGroupList||_utils.emptyfn,this.onUpdateMyRoster=e.onUpdateMyRoster||_utils.emptyfn,this.onBlacklistUpdate=e.onBlacklistUpdate||_utils.emptyfn,_listenNetwork(this.onOnline,this.onOffline)},connection.prototype.heartBeat=function(){var e=!(arguments.length<=0||void 0===arguments[0])&&arguments[0],t=this,o=!/^ws|wss/.test(t.url)||/mobile/.test(navigator.userAgent);if(!this.heartBeatID&&(e||o)){var n={toJid:this.domain,type:"normal"};this.heartBeatID=setInterval(function(){t.ping(n)},this.heartBeatWait)}},connection.prototype.stopHeartBeat=function(){"number"==typeof this.heartBeatID&&(this.heartBeatID=clearInterval(this.heartBeatID))},connection.prototype.sendReceiptsMessage=function(e){var t=$msg({from:this.context.jid||"",to:this.domain,id:e.id||""}).c("received",{xmlns:"urn:xmpp:receipts",id:e.id||""});this.sendCommand(t.tree())},connection.prototype.cacheReceiptsMessage=function(e){this.sendQueue.push(e)},connection.prototype.getStrophe=function(){if("https:"!=location.protocol&&this.isHttpDNS){var e="",t=this.xmppHosts[this.xmppIndex],o=_utils.getXmlFirstChild(t,"domain"),n=_utils.getXmlFirstChild(t,"ip");if(n){e=n.textContent;var r=_utils.getXmlFirstChild(t,"port");"80"!=r.textContent&&(e+=":"+r.textContent)}else e=o.textContent;if(""!=e){var i=/(.+\/\/).+(\/.+)/;this.url=this.url.replace(i,"$1"+e+"$2")}}var s=new Strophe.Connection(this.url,{inactivity:this.inactivity,maxRetries:this.maxRetries,pollingTime:this.pollingTime});return s},connection.prototype.getHostsByTag=function(e,t){var o=_utils.getXmlFirstChild(e,t);if(!o)return console.log(t+" hosts error"),null;var n=o.getElementsByTagName("hosts");return 0==n.length?(console.log(t+" hosts error2"),null):n[0].getElementsByTagName("host")},connection.prototype.getRestFromHttpDNS=function(e,t){if(this.restIndex>this.restTotal)return void console.log("rest hosts all tried,quit");var o="",n=this.restHosts[this.restIndex],r=_utils.getXmlFirstChild(n,"domain"),i=_utils.getXmlFirstChild(n,"ip");if(i){var s=_utils.getXmlFirstChild(n,"port");o=("https:"===location.protocol?"https:":"http:")+"//"+i.textContent+":"+s.textContent}else o=("https:"===location.protocol?"https:":"http:")+"//"+r.textContent;""!=o&&(this.apiUrl=o,e.apiUrl=o),"login"==t?this.login(e):this.signup(e)},connection.prototype.getHttpDNS=function(e,t){if(this.restHosts)return void this.getRestFromHttpDNS(e,t);var o=this,n=function(n,r){n=(new DOMParser).parseFromString(n,"text/xml").documentElement;var i=o.getHostsByTag(n,"rest");if(!i)return void console.log("rest hosts error3");o.restHosts=i,o.restTotal=i.length;var s=o.getHostsByTag(n,"xmpp");return s?(o.xmppHosts=s,o.xmppTotal=s.length,void o.getRestFromHttpDNS(e,t)):void console.log("xmpp hosts error3")},r=function(n,r,i){console.log("getHttpDNS error",n,i),o.dnsIndex++,o.dnsIndex<o.dnsTotal&&o.getHttpDNS(e,t)},i={url:this.dnsArr[this.dnsIndex]+"/easemob/server.xml",dataType:"text",type:"GET",data:{app_key:encodeURIComponent(e.appKey)},success:n||_utils.emptyfn,error:r||_utils.emptyfn};_utils.ajax(i)},connection.prototype.signup=function(e){var t=this,o=e.orgName||"",n=e.appName||"",r=e.appKey||"",i=e.success||EMPTYFN,s=e.error||EMPTYFN;if(!o&&!n&&r){var a=r.split("#");2===a.length&&(o=a[0],n=a[1])}if(!o&&!n)return void s({type:_code.WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR});var c=function(o,n,r){return"https:"!=location.protocol&&t.isHttpDNS&&t.restIndex+1<t.restTotal?(t.restIndex++,void t.getRestFromHttpDNS(e,"signup")):(t.clear(),void s(o))},p=e.https||p,l=e.apiUrl,u=l+"/"+o+"/"+n+"/users",d={username:e.username,password:e.password,nickname:e.nickname||""},m=_utils.stringify(d),h={url:u,dataType:"json",data:m,success:i,error:c};_utils.ajax(h)},connection.prototype.open=function(e){"https:"!=location.protocol&&this.isHttpDNS?(this.dnsIndex=0,this.getHttpDNS(e,"login")):this.login(e)},connection.prototype.login=function(e){var t=_validCheck(e,this);if(t){var o=this;if(!o.isOpened())if(e.accessToken)e.access_token=e.accessToken,o.context.restTokenData=e,_login(e,o);else{var n=e.apiUrl,r=this.context.userId,i=e.pwd||"",s=this.context.appName,a=this.context.orgName,c=function(t,n){o.context.status=_code.STATUS_DOLOGIN_IM,o.context.restTokenData=t,e.success&&e.success(t),_login(t,o)},p=function(t,n,r){return e.error&&e.error(),"https:"!=location.protocol&&o.isHttpDNS&&o.restIndex+1<o.restTotal?(o.restIndex++,void o.getRestFromHttpDNS(e,"login")):(o.clear(),void(t.error&&t.error_description?o.onError({type:_code.WEBIM_CONNCTION_OPEN_USERGRID_ERROR,data:t,xhr:n}):o.onError({type:_code.WEBIM_CONNCTION_OPEN_ERROR,data:t,xhr:n})))};this.context.status=_code.STATUS_DOLOGIN_USERGRID;var l={grant_type:"password",username:r,password:i,timestamp:+new Date},u=_utils.stringify(l),d={url:n+"/"+a+"/"+s+"/token",dataType:"json",data:u,success:c||_utils.emptyfn,error:p||_utils.emptyfn};_utils.ajax(d)}}},connection.prototype.attach=function(e){var t=_validCheck(e,this);if(t){e=e||{};var o=e.accessToken||"";if(""==o)return void this.onError({type:_code.WEBIM_CONNCTION_TOKEN_NOT_ASSIGN_ERROR});var n=e.sid||"";if(""===n)return void this.onError({type:_code.WEBIM_CONNCTION_SESSIONID_NOT_ASSIGN_ERROR});var r=e.rid||"";if(""===r)return void this.onError({type:_code.WEBIM_CONNCTION_RID_NOT_ASSIGN_ERROR});var i=this.getStrophe();this.context.accessToken=o,this.context.stropheConn=i,this.context.status=_code.STATUS_DOLOGIN_IM;var s=this,a=function(e,t){_loginCallback(e,t,s)},c=this.context.jid,p=this.wait,l=this.hold,u=this.wind||5;i.attach(c,n,r,a,p,l,u)}},connection.prototype.close=function(e){this.stopHeartBeat();var t=this.context.status;t!=_code.STATUS_INIT&&(this.isClosed()||this.isClosing()||(this.context.status=_code.STATUS_CLOSING,this.context.stropheConn.disconnect(e)))},connection.prototype.addHandler=function(e,t,o,n,r,i,s){this.context.stropheConn.addHandler(e,t,o,n,r,i,s)},connection.prototype.notifyVersion=function(e,t){var o=(_getJid({},this),$iq({from:this.context.jid||"",to:this.domain,type:"result"}).c("query",{xmlns:"jabber:iq:version"}).c("name").t("easemob").up().c("version").t(_version).up().c("os").t("webim")),e=e||_utils.emptyfn,n=t||this.onError,r=function(e){n({type:_code.WEBIM_CONNCTION_NOTIFYVERSION_ERROR,data:e})};this.context.stropheConn.sendIQ(o.tree(),e,r)},connection.prototype.handlePresence=function(e){if(!this.isClosed()){var t=e.getAttribute("from")||"",o=e.getAttribute("to")||"",n=e.getAttribute("type")||"",r=e.getAttribute("presence_type")||"",i=_parseNameFromJidFn(t),s=_parseNameFromJidFn(o),a=!1,c={from:i,to:s,fromJid:t,toJid:o,type:n,chatroom:!!e.getElementsByTagName("roomtype").length},p=e.getElementsByTagName("show");if(p&&p.length>0){var l=p[0];c.show=Strophe.getText(l)}var u=e.getElementsByTagName("status");if(u&&u.length>0){var d=u[0];c.status=Strophe.getText(d),c.code=d.getAttribute("code")}var m=e.getElementsByTagName("priority");if(m&&m.length>0){var h=m[0];c.priority=Strophe.getText(h)}var f=e.getElementsByTagName("error");if(f&&f.length>0){var f=f[0];c.error={code:f.getAttribute("code")}}var _=e.getElementsByTagName("destroy");if(_&&_.length>0){var _=_[0];c.destroy=!0;var y=_.getElementsByTagName("reason");y&&y.length>0&&(c.reason=Strophe.getText(y[0]))}var g=e.getElementsByTagName("item");if(g&&g.length>0){var E=g[0],O=E.getAttribute("role"),I=E.getAttribute("jid"),N=E.getAttribute("affiliation");if("none"==O&&I){var v=_parseNameFromJidFn(I),R=E.getElementsByTagName("actor")[0],T=R.getAttribute("nick");c.actor=T,c.kicked=v}"moderator"==O&&"201"==c.code&&("owner"===N?(c.type="createGroupACK",a=!0):c.type="joinPublicGroupSuccess")}var C=e.getElementsByTagName("apply");if(C&&C.length>0){C=C[0];var x=C.getAttribute("toNick"),b=C.getAttribute("to"),S=C.getAttribute("from"),M=_parseNameFromJidFn(b);_parseNameFromJidFn(S);c.toNick=x,c.groupName=M,c.type="joinGroupNotifications";var y=C.getElementsByTagName("reason");y&&y.length>0&&(c.reason=Strophe.getText(y[0]))}if(c.chatroom){c.presence_type=r,c.original_type=c.type;var A=t.slice(t.lastIndexOf("/")+1);A===this.context.userId&&(""!==c.type||c.code?"unavailable"!==r&&"unavailable"!==c.type||(c.status?110==c.code?c.type="leaveChatRoom":c.error&&406==c.error.code&&(c.type="reachChatRoomCapacity"):c.type="leaveChatRoom"):c.type="joinChatRoomSuccess")}else if(c.presence_type=r,c.original_type=n,/subscribe/.test(c.type));else if(""!=n||c.status||c.error||a){if("unavailable"===r||"unavailable"===n)if(c.destroy)c.type="deleteGroupChat";else if(307==c.code||321==c.code){var B=e.getAttribute("nick");B?c.type="removedFromGroup":c.type="leaveGroup"}}else c.type="joinPublicGroupSuccess";this.onPresence(c,e)}},connection.prototype.handlePing=function(e){if(!this.isClosed()){var t=e.getAttribute("id"),o=e.getAttribute("from"),n=e.getAttribute("to"),r=$iq({from:n,to:o,id:t,type:"result"});this.sendCommand(r.tree())}},connection.prototype.handleIq=function(e){return!0},connection.prototype.handleIqPrivacy=function(e){var t=e.getElementsByTagName("list");0!=t.length&&this.getBlacklist()},connection.prototype.handleIqRoster=function(e){var t=e.getAttribute("id"),o=e.getAttribute("from")||"",n=(_parseNameFromJidFn(o),this.context.jid),r=(this.context.userId,$iq({type:"result",id:t,from:n}));this.sendCommand(r.tree());var i=e.getElementsByTagName("query");if(i&&i.length>0){var s=i[0],a=_parseFriend(s,this,o);this.onRoster(a)}return!0},connection.prototype.handleMessage=function(e){var t=this;if(!this.isClosed()){var o=e.getAttribute("id")||"";this.cacheReceiptsMessage({id:o});var n=_parseResponseMessage(e);if(n.errorMsg)return void this.handlePresence(e);var r=e.getElementsByTagName("error"),i="",s="",a=!1;if(r.length>0){a=!0,i=r[0].getAttribute("code");var c=r[0].getElementsByTagName("text");s=c[0].textContent||c[0].text,log("handle error",i,s)}var p=n.data;for(var l in p)if(p.hasOwnProperty(l)){var u=p[l];if(u.from&&u.to){var d=(u.from+"").toLowerCase(),m=(u.to+"").toLowerCase(),h=u.ext||{},f="",_=e.getElementsByTagName("roomtype");f=_.length?_[0].getAttribute("type")||"chat":e.getAttribute("type")||"chat";var y=u.bodies;if(y&&0!=y.length){var g=u.bodies[0],E=g.type;try{switch(E){case"txt":var O=g.msg,I=_utils.parseTextMessage(O,WebIM.Emoji);if(I.isemoji){var u={id:o,type:f,from:d,to:m,delay:n.delayTimeStamp,data:I.body,ext:h};!u.delay&&delete u.delay,u.error=a,u.errorText=s,u.errorCode=i,this.onEmojiMessage(u)}else{var u={id:o,type:f,from:d,to:m,delay:n.delayTimeStamp,data:O,ext:h};!u.delay&&delete u.delay,u.error=a,u.errorText=s,u.errorCode=i,this.onTextMessage(u)}break;case"img":var N=0,v=0;g.size&&(N=g.size.width,v=g.size.height);var u={id:o,type:f,from:d,to:m,url:"https:"!=location.protocol&&t.isHttpDNS?t.apiUrl+g.url.substr(g.url.indexOf("/",9)):g.url,secret:g.secret,filename:g.filename,thumb:g.thumb,thumb_secret:g.thumb_secret,file_length:g.file_length||"",width:N,height:v,filetype:g.filetype||"",accessToken:this.context.accessToken||"",ext:h,delay:n.delayTimeStamp};!u.delay&&delete u.delay,u.error=a,u.errorText=s,u.errorCode=i,this.onPictureMessage(u);break;case"audio":var u={id:o,type:f,from:d,to:m,url:"https:"!=location.protocol&&t.isHttpDNS?t.apiUrl+g.url.substr(g.url.indexOf("/",9)):g.url,secret:g.secret,filename:g.filename,length:g.length||"",file_length:g.file_length||"",filetype:g.filetype||"",accessToken:this.context.accessToken||"",ext:h,delay:n.delayTimeStamp};!u.delay&&delete u.delay,u.error=a,u.errorText=s,u.errorCode=i,this.onAudioMessage(u);break;case"file":var u={id:o,type:f,from:d,to:m,url:"https:"!=location.protocol&&t.isHttpDNS?t.apiUrl+g.url.substr(g.url.indexOf("/",9)):g.url,secret:g.secret,filename:g.filename,file_length:g.file_length,accessToken:this.context.accessToken||"",ext:h,delay:n.delayTimeStamp};!u.delay&&delete u.delay,u.error=a,u.errorText=s,u.errorCode=i,this.onFileMessage(u);break;case"loc":var u={id:o,type:f,from:d,to:m,addr:g.addr,lat:g.lat,lng:g.lng,ext:h,delay:n.delayTimeStamp};!u.delay&&delete u.delay,u.error=a,u.errorText=s,u.errorCode=i,this.onLocationMessage(u);break;case"video":var u={id:o,type:f,from:d,to:m,url:"https:"!=location.protocol&&t.isHttpDNS?t.apiUrl+g.url.substr(g.url.indexOf("/",9)):g.url,secret:g.secret,filename:g.filename,file_length:g.file_length,accessToken:this.context.accessToken||"",ext:h,delay:n.delayTimeStamp};!u.delay&&delete u.delay,u.error=a,u.errorText=s,u.errorCode=i,this.onVideoMessage(u);break;case"cmd":var u={id:o,from:d,to:m,action:g.action,ext:h,delay:n.delayTimeStamp};!u.delay&&delete u.delay,u.error=a,u.errorText=s,u.errorCode=i,this.onCmdMessage(u)}}catch(e){this.onError({type:_code.WEBIM_CONNCTION_CALLBACK_INNER_ERROR,data:e})}}}}}},connection.prototype.handleReceivedMessage=function(e){try{this.onReceivedMessage(e)}catch(e){this.onError({type:_code.WEBIM_CONNCTION_CALLBACK_INNER_ERROR,data:e})}var t,o,n=e.getElementsByTagName("received");if(n.length>0&&(t=n[0].childNodes&&n[0].childNodes.length>0?n[0].childNodes[0].nodeValue:n[0].innerHTML||n[0].innerText,o=n[0].getAttribute("mid")),_msgHash[t]){try{_msgHash[t].msg.success instanceof Function&&_msgHash[t].msg.success(t,o)}catch(e){this.onError({type:_code.WEBIM_CONNCTION_CALLBACK_INNER_ERROR,data:e})}delete _msgHash[t]}},connection.prototype.handleInviteMessage=function(e){var t=null,o=e.getElementsByTagName("invite"),n=e.getElementsByTagName("reason")[0],r=n.textContent,i=e.getAttribute("id")||"";if(this.sendReceiptsMessage({id:i}),o&&o.length>0){var s=o[0].getAttribute("from");t=_parseNameFromJidFn(s)}var a=e.getElementsByTagName("x"),c=null;if(a&&a.length>0)for(var p=0;p<a.length;p++)if("jabber:x:conference"===a[p].namespaceURI){var l=a[p].getAttribute("jid");c=_parseNameFromJidFn(l)}this.onInviteMessage({type:"invite",from:t,roomid:c,reason:r})},connection.prototype.sendCommand=function(e,t){this.isOpened()?this.context.stropheConn.send(e):this.onError({type:_code.WEBIM_CONNCTION_DISCONNECTED,reconnect:!0})},connection.prototype.getUniqueId=function(e){var t=new Date,o=new Date(2010,1,1),n=t.getTime()-o.getTime(),r=parseInt(n).toString(16);return"string"==typeof e||"number"==typeof e?e+"_"+r:"WEBIM_"+r},connection.prototype.send=function(e){var t=this;if(this.isWindowSDK)WebIM.doQuery('{"type":"sendMessage","to":"'+e.to+'","message_type":"'+e.type+'","msg":"'+encodeURI(e.msg)+'","chatType":"'+e.chatType+'"}',function(e){},function(e,o){var n={data:{data:"send"},type:_code.WEBIM_MESSAGE_SED_ERROR};t.onError(n)});else if("[object Object]"===Object.prototype.toString.call(e)){var o=this.context.appKey||"",n=o+"_"+e.to+"@"+this.domain;e.group&&(n=o+"_"+e.to+"@conference."+this.domain),e.resource&&(n=n+"/"+e.resource),e.toJid=n,e.id=e.id||this.getUniqueId(),_msgHash[e.id]=new _message(e),_msgHash[e.id].send(this)}else"string"==typeof e&&_msgHash[e]&&_msgHash[e].send(this)},connection.prototype.addRoster=function(e){var t=_getJid(e,this),o=e.name||"",n=e.groups||"",r=$iq({type:"set"});if(r.c("query",{xmlns:"jabber:iq:roster"}),r.c("item",{jid:t,name:o}),n)for(var i=0;i<n.length;i++)r.c("group").t(n[i]).up();var s=e.success||_utils.emptyfn,a=e.error||_utils.emptyfn;this.context.stropheConn.sendIQ(r.tree(),s,a)},connection.prototype.removeRoster=function(e){var t=_getJid(e,this),o=$iq({type:"set"}).c("query",{xmlns:"jabber:iq:roster"}).c("item",{jid:t,subscription:"remove"}),n=e.success||_utils.emptyfn,r=e.error||_utils.emptyfn;this.context.stropheConn.sendIQ(o,n,r)},connection.prototype.getRoster=function(e){var t=$iq({type:"get"}).c("query",{xmlns:"jabber:iq:roster"}),e=e||{},o=e.success||this.onRoster,n=function(e){var t=[],n=e.getElementsByTagName("query");if(n&&n.length>0){var r=n[0];t=_parseFriend(r)}o(t,e)},r=e.error||this.onError,i=function(e){r({type:_code.WEBIM_CONNCTION_GETROSTER_ERROR,data:e})};this.isOpened()?this.context.stropheConn.sendIQ(t.tree(),n,i):r({type:_code.WEBIM_CONNCTION_DISCONNECTED})},connection.prototype.subscribe=function(e){var t=_getJid(e,this),o=$pres({to:t,type:"subscribe"});e.message&&o.c("status").t(e.message).up(),e.nick&&o.c("nick",{xmlns:"http://jabber.org/protocol/nick"}).t(e.nick),this.sendCommand(o.tree())},connection.prototype.subscribed=function(e){var t=_getJid(e,this),o=$pres({to:t,type:"subscribed"});e.message&&o.c("status").t(e.message).up(),this.sendCommand(o.tree())},connection.prototype.unsubscribe=function(e){var t=_getJid(e,this),o=$pres({to:t,type:"unsubscribe"});e.message&&o.c("status").t(e.message),this.sendCommand(o.tree())},connection.prototype.unsubscribed=function(e){var t=_getJid(e,this),o=$pres({to:t,type:"unsubscribed"});e.message&&o.c("status").t(e.message).up(),this.sendCommand(o.tree())},connection.prototype.joinPublicGroup=function(e){var t=this.context.appKey+"_"+e.roomId+"@conference."+this.domain,o=t+"/"+this.context.userId,n=e.success||_utils.emptyfn,r=e.error||_utils.emptyfn,i=function(e){r({type:_code.WEBIM_CONNCTION_JOINROOM_ERROR,data:e})},s=$pres({from:this.context.jid,to:o}).c("x",{xmlns:Strophe.NS.MUC});this.context.stropheConn.sendIQ(s.tree(),n,i)},connection.prototype.listRooms=function(e){var t=$iq({to:e.server||"conference."+this.domain,from:this.context.jid,type:"get"}).c("query",{xmlns:Strophe.NS.DISCO_ITEMS}),o=e.success||_utils.emptyfn,n=e.error||this.onError,r=function(e){var t=[];t=_parseRoom(e);try{o(t)}catch(e){n({type:_code.WEBIM_CONNCTION_GETROOM_ERROR,data:e})}},i=e.error||_utils.emptyfn,s=function(e){i({type:_code.WEBIM_CONNCTION_GETROOM_ERROR,data:e})};this.context.stropheConn.sendIQ(t.tree(),r,s)},connection.prototype.queryRoomMember=function(e){var t=(this.domain,[]),o=$iq({to:this.context.appKey+"_"+e.roomId+"@conference."+this.domain,type:"get"}).c("query",{xmlns:Strophe.NS.MUC+"#admin"}).c("item",{affiliation:"member"}),n=e.success||_utils.emptyfn,r=function(e){var o=e.getElementsByTagName("item");if(o)for(var r=0;r<o.length;r++){var i=o[r],s={jid:i.getAttribute("jid"),affiliation:"member"};t.push(s)}n(t)},i=e.error||_utils.emptyfn,s=function(e){i({type:_code.WEBIM_CONNCTION_GETROOMMEMBER_ERROR,data:e})};this.context.stropheConn.sendIQ(o.tree(),r,s)},connection.prototype.queryRoomInfo=function(e){var t=this.domain,o=$iq({to:this.context.appKey+"_"+e.roomId+"@conference."+t,type:"get"}).c("query",{xmlns:Strophe.NS.DISCO_INFO}),n=e.success||_utils.emptyfn,r=[],i=function(e){var o="",i=e.getElementsByTagName("feature");switch(i&&(o=i[1].getAttribute("var")+"|"+i[3].getAttribute("var")+"|"+i[4].getAttribute("var")),o){case"muc_public|muc_membersonly|muc_notallowinvites":o="PUBLIC_JOIN_APPROVAL";break;case"muc_public|muc_open|muc_notallowinvites":o="PUBLIC_JOIN_OPEN";break;case"muc_hidden|muc_membersonly|muc_allowinvites":o="PRIVATE_MEMBER_INVITE";break;case"muc_hidden|muc_membersonly|muc_notallowinvites":o="PRIVATE_OWNER_INVITE"}var s=e.getElementsByTagName("field"),a={};if(s){for(var c=0;c<s.length;c++){var p=s[c],l=p.getAttribute("var"),u=l.split("_")[1];switch(l){case"muc#roominfo_occupants":case"muc#roominfo_maxusers":case"muc#roominfo_affiliations":case"muc#roominfo_description":a[u]=p.textContent||p.text||"";break;case"muc#roominfo_owner":var d={jid:(p.textContent||p.text)+"@"+t,affiliation:"owner"};r.push(d),a[u]=p.textContent||p.text}}a.name=e.getElementsByTagName("identity")[0].getAttribute("name")}log(o,r,a),n(o,r,a)},s=e.error||_utils.emptyfn,a=function(e){s({type:_code.WEBIM_CONNCTION_GETROOMINFO_ERROR,data:e})};this.context.stropheConn.sendIQ(o.tree(),i,a)},connection.prototype.queryRoomOccupants=function(e){var t=e.success||_utils.emptyfn,o=function(e){
var o=[];o=_parseRoomOccupants(e),t(o)},n=e.error||_utils.emptyfn,r=function(e){n({type:_code.WEBIM_CONNCTION_GETROOMOCCUPANTS_ERROR,data:e})},i={xmlns:Strophe.NS.DISCO_ITEMS},s=$iq({from:this.context.jid,to:this.context.appKey+"_"+e.roomId+"@conference."+this.domain,type:"get"}).c("query",i);this.context.stropheConn.sendIQ(s.tree(),o,r)},connection.prototype.setUserSig=function(e){var t=$pres({xmlns:"jabber:client"});e=e||"",t.c("status").t(e),this.sendCommand(t.tree())},connection.prototype.setPresence=function(e,t){var o=$pres({xmlns:"jabber:client"});e&&(t?(o.c("show").t(e),o.up().c("status").t(t)):o.c("show").t(e)),this.sendCommand(o.tree())},connection.prototype.getPresence=function(){var e=$pres({xmlns:"jabber:client"});this.sendCommand(e.tree())},connection.prototype.ping=function(e){var e=e||{},t=_getJid(e,this),o=$iq({from:this.context.jid||"",to:t,type:"get"}).c("ping",{xmlns:"urn:xmpp:ping"}),n=e.success||_utils.emptyfn,r=e.error||this.onError,i=function(e){r({type:_code.WEBIM_CONNCTION_PING_ERROR,data:e})};this.isOpened()?this.context.stropheConn.sendIQ(o.tree(),n,i):r({type:_code.WEBIM_CONNCTION_DISCONNECTED})},connection.prototype.isOpened=function(){return this.context.status==_code.STATUS_OPENED},connection.prototype.isOpening=function(){var e=this.context.status;return e==_code.STATUS_DOLOGIN_USERGRID||e==_code.STATUS_DOLOGIN_IM},connection.prototype.isClosing=function(){return this.context.status==_code.STATUS_CLOSING},connection.prototype.isClosed=function(){return this.context.status==_code.STATUS_CLOSED},connection.prototype.clear=function(){var e=this.context.appKey;if(this.errorType!=_code.WEBIM_CONNCTION_DISCONNECTED&&(this.context={status:_code.STATUS_INIT,appKey:e}),this.intervalId&&clearInterval(this.intervalId),this.restIndex=0,this.xmppIndex=0,this.errorType==_code.WEBIM_CONNCTION_CLIENT_LOGOUT||this.errorType==-1){var t={data:{data:"logout"},type:_code.WEBIM_CONNCTION_CLIENT_LOGOUT};this.onError(t)}},connection.prototype.getChatRooms=function(e){if(!_utils.isCanSetRequestHeader)return void t.onError({type:_code.WEBIM_CONNCTION_NOT_SUPPORT_CHATROOM_ERROR});var t=this,o=e.accessToken||this.context.accessToken;if(o){var n=e.apiUrl,r=this.context.appName,i=this.context.orgName;if(!r||!i)return void t.onError({type:_code.WEBIM_CONNCTION_AUTH_ERROR});var s=function(t,o){"function"==typeof e.success&&e.success(t)},a=function(e,o,n){e.error&&e.error_description&&t.onError({type:_code.WEBIM_CONNCTION_LOAD_CHATROOM_ERROR,msg:e.error_description,data:e,xhr:o})},c={pagenum:parseInt(e.pagenum)||1,pagesize:parseInt(e.pagesize)||20},p={url:n+"/"+i+"/"+r+"/chatrooms",dataType:"json",type:"GET",headers:{Authorization:"Bearer "+o},data:c,success:s||_utils.emptyfn,error:a||_utils.emptyfn};_utils.ajax(p)}else t.onError({type:_code.WEBIM_CONNCTION_TOKEN_NOT_ASSIGN_ERROR})},connection.prototype.joinChatRoom=function(e){var t=this.context.appKey+"_"+e.roomId+"@conference."+this.domain,o=t+"/"+this.context.userId,n=e.success||_utils.emptyfn,r=e.error||_utils.emptyfn,i=function(e){r({type:_code.WEBIM_CONNCTION_JOINCHATROOM_ERROR,data:e})},s=$pres({from:this.context.jid,to:o}).c("x",{xmlns:Strophe.NS.MUC+"#user"}).c("item",{affiliation:"member",role:"participant"}).up().up().c("roomtype",{xmlns:"easemob:x:roomtype",type:"chatroom"});this.context.stropheConn.sendIQ(s.tree(),n,i)},connection.prototype.quitChatRoom=function(e){var t=this.context.appKey+"_"+e.roomId+"@conference."+this.domain,o=t+"/"+this.context.userId,n=e.success||_utils.emptyfn,r=e.error||_utils.emptyfn,i=function(e){r({type:_code.WEBIM_CONNCTION_QUITCHATROOM_ERROR,data:e})},s=$pres({from:this.context.jid,to:o,type:"unavailable"}).c("x",{xmlns:Strophe.NS.MUC+"#user"}).c("item",{affiliation:"none",role:"none"}).up().up().c("roomtype",{xmlns:"easemob:x:roomtype",type:"chatroom"});this.context.stropheConn.sendIQ(s.tree(),n,i)},connection.prototype._onReceiveInviteFromGroup=function(info){info=eval("("+info+")");var self=this,options={title:"Group invitation",msg:info.user+" invites you to join into group:"+info.group_id,agree:function(){WebIM.doQuery('{"type":"acceptInvitationFromGroup","id":"'+info.group_id+'","user":"'+info.user+'"}',function(e){},function(e,t){var o={data:{data:"acceptInvitationFromGroup error:"+t},type:_code.WEBIM_CONNECTION_ACCEPT_INVITATION_FROM_GROUP};self.onError(o)})},reject:function(){WebIM.doQuery('{"type":"declineInvitationFromGroup","id":"'+info.group_id+'","user":"'+info.user+'"}',function(e){},function(e,t){var o={data:{data:"declineInvitationFromGroup error:"+t},type:_code.WEBIM_CONNECTION_DECLINE_INVITATION_FROM_GROUP};self.onError(o)})}};this.onConfirmPop(options)},connection.prototype._onReceiveInviteAcceptionFromGroup=function(info){info=eval("("+info+")");var options={title:"Group invitation response",msg:info.user+" agreed to join into group:"+info.group_id,agree:function(){}};this.onConfirmPop(options)},connection.prototype._onReceiveInviteDeclineFromGroup=function(info){info=eval("("+info+")");var options={title:"Group invitation response",msg:info.user+" rejected to join into group:"+info.group_id,agree:function(){}};this.onConfirmPop(options)},connection.prototype._onAutoAcceptInvitationFromGroup=function(info){info=eval("("+info+")");var options={title:"Group invitation",msg:"You had joined into the group:"+info.group_name+" automatically.Inviter:"+info.user,agree:function(){}};this.onConfirmPop(options)},connection.prototype._onLeaveGroup=function(info){info=eval("("+info+")");var options={title:"Group notification",msg:"You have been out of the group:"+info.group_id+".Reason:"+info.msg,agree:function(){}};this.onConfirmPop(options)},connection.prototype._onReceiveJoinGroupApplication=function(info){info=eval("("+info+")");var self=this,options={title:"Group join application",msg:info.user+" applys to join into group:"+info.group_id,agree:function(){WebIM.doQuery('{"type":"acceptJoinGroupApplication","id":"'+info.group_id+'","user":"'+info.user+'"}',function(e){},function(e,t){var o={data:{data:"acceptJoinGroupApplication error:"+t},type:_code.WEBIM_CONNECTION_ACCEPT_JOIN_GROUP};self.onError(o)})},reject:function(){WebIM.doQuery('{"type":"declineJoinGroupApplication","id":"'+info.group_id+'","user":"'+info.user+'"}',function(e){},function(e,t){var o={data:{data:"declineJoinGroupApplication error:"+t},type:_code.WEBIM_CONNECTION_DECLINE_JOIN_GROUP};self.onError(o)})}};this.onConfirmPop(options)},connection.prototype._onReceiveAcceptionFromGroup=function(info){info=eval("("+info+")");var options={title:"Group notification",msg:"You had joined into the group:"+info.group_name+".",agree:function(){}};this.onConfirmPop(options)},connection.prototype._onReceiveRejectionFromGroup=function(){info=eval("("+info+")");var options={title:"Group notification",msg:"You have been rejected to join into the group:"+info.group_name+".",agree:function(){}};this.onConfirmPop(options)},connection.prototype._onUpdateMyGroupList=function(e){this.onUpdateMyGroupList(e)},connection.prototype._onUpdateMyRoster=function(e){this.onUpdateMyRoster(e)},connection.prototype.reconnect=function(){var e=this;setTimeout(function(){_login(e.context.restTokenData,e)},1e3*(0==this.autoReconnectNumTotal?0:this.autoReconnectInterval)),this.autoReconnectNumTotal++},connection.prototype.closed=function(){var e={data:{data:"Closed error"},type:_code.WEBIM_CONNECTION_CLOSED};this.onError(e)},connection.prototype.getBlacklist=function(e){e=e||{};var t=$iq({type:"get"}),o=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,r=this;t.c("query",{xmlns:"jabber:iq:privacy"}).c("list",{name:"special"}),this.context.stropheConn.sendIQ(t.tree(),function(e){r.onBlacklistUpdate(_parsePrivacy(e)),o()},function(){r.onBlacklistUpdate([]),n()})},connection.prototype.addToBlackList=function(e){for(var t=$iq({type:"set"}),o=e.list||{},n=e.type||"jid",r=e.success||_utils.emptyfn,i=e.error||_utils.emptyfn,s=t.c("query",{xmlns:"jabber:iq:privacy"}).c("list",{name:"special"}),a=Object.keys(o),c=a.length,p=2,l=0;l<c;l++){var u=o[a[l]],n=u.type||"jid",d=u.jid;s=s.c("item",{action:"deny",order:p++,type:n,value:d}).c("message"),l!==c-1&&(s=s.up().up())}this.context.stropheConn.sendIQ(s.tree(),r,i)},connection.prototype.removeFromBlackList=function(e){for(var t=$iq({type:"set"}),o=e.list||{},n=e.success||_utils.emptyfn,r=e.error||_utils.emptyfn,i=t.c("query",{xmlns:"jabber:iq:privacy"}).c("list",{name:"special"}),s=Object.keys(o),a=s.length,c=0;c<a;c++){var p=o[s[c]],l=p.type||"jid",u=p.jid,d=p.order;i=i.c("item",{action:"deny",order:d,type:l,value:u}).c("message"),c!==a-1&&(i=i.up().up())}this.context.stropheConn.sendIQ(i.tree(),n,r)},connection.prototype._getGroupJid=function(e){var t=this.context.appKey||"";return t+"_"+e+"@conference."+this.domain},connection.prototype.addToGroupBlackList=function(e){var t=e.success||_utils.emptyfn,o=e.error||_utils.emptyfn,n=_getJid(e,this),r="admin",i=this._getGroupJid(e.roomId),s=$iq({type:"set",to:i});s.c("query",{xmlns:"http://jabber.org/protocol/muc#"+r}).c("item",{affiliation:"outcast",jid:n}),this.context.stropheConn.sendIQ(s.tree(),t,o)},connection.prototype.getGroupBlacklist=function(e){var t=e.success||_utils.emptyfn,o=e.error||_utils.emptyfn,n="admin",r=this._getGroupJid(e.roomId),i=$iq({type:"get",to:r});i.c("query",{xmlns:"http://jabber.org/protocol/muc#"+n}).c("item",{affiliation:"outcast"}),this.context.stropheConn.sendIQ(i.tree(),function(e){log("getGroupBlackList"),t(_parseGroupBlacklist(e))},function(){o()})},connection.prototype.removeGroupMemberFromBlacklist=function(e){var t=e.success||_utils.emptyfn,o=e.error||_utils.emptyfn,n=_getJid(e,this),r="admin",i=this._getGroupJid(e.roomId),s=$iq({type:"set",to:i});s.c("query",{xmlns:"http://jabber.org/protocol/muc#"+r}).c("item",{affiliation:"none",jid:n}),this.context.stropheConn.sendIQ(s.tree(),function(e){t()},function(){o()})},connection.prototype.changeGroupSubject=function(e){var t=e.success||_utils.emptyfn,o=e.error||_utils.emptyfn,n="owner",r=this._getGroupJid(e.roomId),i=$iq({type:"set",to:r});i.c("query",{xmlns:"http://jabber.org/protocol/muc#"+n}).c("x",{type:"submit",xmlns:"jabber:x:data"}).c("field",{var:"FORM_TYPE"}).c("value").t("http://jabber.org/protocol/muc#roomconfig").up().up().c("field",{var:"muc#roomconfig_roomname"}).c("value").t(e.subject).up().up().c("field",{var:"muc#roomconfig_roomdesc"}).c("value").t(e.description),this.context.stropheConn.sendIQ(i.tree(),function(e){t()},function(){o()})},connection.prototype.destroyGroup=function(e){var t=e.success||_utils.emptyfn,o=e.error||_utils.emptyfn,n="owner",r=this._getGroupJid(e.roomId),i=$iq({type:"set",to:r});i.c("query",{xmlns:"http://jabber.org/protocol/muc#"+n}).c("destroy").c("reason").t(e.reason||""),this.context.stropheConn.sendIQ(i.tree(),function(e){t()},function(){o()})},connection.prototype.leaveGroupBySelf=function(e){var t=this,o=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,r=_getJid(e,this),i="admin",s=this._getGroupJid(e.roomId),a=$iq({type:"set",to:s});a.c("query",{xmlns:"http://jabber.org/protocol/muc#"+i}).c("item",{affiliation:"none",jid:r}),this.context.stropheConn.sendIQ(a.tree(),function(e){o(e);var n=$pres({type:"unavailable",to:s+"/"+t.context.userId});t.sendCommand(n.tree())},function(e){n(e)})},connection.prototype.leaveGroup=function(e){for(var t=e.success||_utils.emptyfn,o=e.error||_utils.emptyfn,n=e.list||[],r="admin",i=this._getGroupJid(e.roomId),s=$iq({type:"set",to:i}),a=s.c("query",{xmlns:"http://jabber.org/protocol/muc#"+r}),c=Object.keys(n),p=c.length,l=0;l<p;l++){var u=n[c[l]],d=_getJidByName(u,this);a=a.c("item",{affiliation:"none",jid:d}).up().c("item",{role:"none",jid:d}).up()}this.context.stropheConn.sendIQ(s.tree(),function(e){t(e)},function(e){o(e)})},connection.prototype.addGroupMembers=function(e){for(var t=e.success||_utils.emptyfn,o=e.error||_utils.emptyfn,n=e.list||[],r="admin",i=this._getGroupJid(e.roomId),s=$iq({type:"set",to:i}),a=s.c("query",{xmlns:"http://jabber.org/protocol/muc#"+r}),c=n.length,p=0;p<c;p++){var l=n[p],u=_getJidByName(l,this);a=a.c("item",{affiliation:"member",jid:u}).up();var d=$msg({to:i}).c("x",{xmlns:"http://jabber.org/protocol/muc#user"}).c("invite",{to:u}).c("reason").t(e.reason||"");this.sendCommand(d.tree())}this.context.stropheConn.sendIQ(s.tree(),function(e){t(e)},function(e){o(e)})},connection.prototype.acceptInviteFromGroup=function(e){e.success=function(){},this.addGroupMembers(e)},connection.prototype.rejectInviteFromGroup=function(e){},connection.prototype.createGroupAsync=function(e){var t=e.from,o=this,n=this._getGroupJid(t),r=(n+"/"+this.context.userId,this.groupOption),i=e.success||_utils.emptyfn,s=$iq({type:"get",to:n}).c("query",{xmlns:"http://jabber.org/protocol/muc#owner"});o.context.stropheConn.sendIQ(s.tree(),function(e){if("setAttribute"in e){var s=e.getElementsByTagName("x")[0];s.setAttribute("type","submit")}else Strophe.forEachChild(e,"x",function(e){e.setAttribute("type","submit")});Strophe.info("step 5 ----------"),Strophe.forEachChild(s,"field",function(e){var t=e.getAttribute("var"),o=e.getElementsByTagName("value")[0];switch(Strophe.info(t),t){case"muc#roomconfig_roomname":_setText(o,r.subject||"");break;case"muc#roomconfig_roomdesc":_setText(o,r.description||"");break;case"muc#roomconfig_publicroom":_setText(o,+r.optionsPublic);break;case"muc#roomconfig_membersonly":_setText(o,+r.optionsMembersOnly);break;case"muc#roomconfig_moderatedroom":_setText(o,+r.optionsModerate);break;case"muc#roomconfig_persistentroom":_setText(o,1);break;case"muc#roomconfig_allowinvites":_setText(o,+r.optionsAllowInvites);break;case"muc#roomconfig_allowvisitornickchange":_setText(o,0);break;case"muc#roomconfig_allowvisitorstatus":_setText(o,0);break;case"allow_private_messages":_setText(o,0);break;case"allow_private_messages_from_visitors":_setText(o,"nobody")}});var a=$iq({to:n,type:"set"}).c("query",{xmlns:"http://jabber.org/protocol/muc#owner"}).cnode(s);o.context.stropheConn.sendIQ(a.tree(),function(e){o.addGroupMembers({list:r.members,roomId:t}),i(r)},function(e){})},function(e){})},connection.prototype.createGroup=function(e){this.groupOption=e;var t=+new Date,o=this._getGroupJid(t),n=o+"/"+this.context.userId,r=$pres({to:n}).c("x",{xmlns:"http://jabber.org/protocol/muc"}).up().c("create",{xmlns:"http://jabber.org/protocol/muc"}).up();this.sendCommand(r.tree())};var WebIM=window.WebIM||{};WebIM.connection=connection,WebIM.utils=_utils,WebIM.statusCode=_code,WebIM.message=_msg.message,WebIM.doQuery=function(e,t,o){"undefined"!=typeof window.cefQuery&&window.cefQuery({request:e,persistent:!1,onSuccess:t,onFailure:o})},module.exports=WebIM},function(e,t){!function(){t.code={WEBIM_CONNCTION_USER_NOT_ASSIGN_ERROR:0,WEBIM_CONNCTION_OPEN_ERROR:1,WEBIM_CONNCTION_AUTH_ERROR:2,WEBIM_CONNCTION_OPEN_USERGRID_ERROR:3,WEBIM_CONNCTION_ATTACH_ERROR:4,WEBIM_CONNCTION_ATTACH_USERGRID_ERROR:5,WEBIM_CONNCTION_REOPEN_ERROR:6,WEBIM_CONNCTION_SERVER_CLOSE_ERROR:7,WEBIM_CONNCTION_SERVER_ERROR:8,WEBIM_CONNCTION_IQ_ERROR:9,WEBIM_CONNCTION_PING_ERROR:10,WEBIM_CONNCTION_NOTIFYVERSION_ERROR:11,WEBIM_CONNCTION_GETROSTER_ERROR:12,WEBIM_CONNCTION_CROSSDOMAIN_ERROR:13,WEBIM_CONNCTION_LISTENING_OUTOF_MAXRETRIES:14,WEBIM_CONNCTION_RECEIVEMSG_CONTENTERROR:15,WEBIM_CONNCTION_DISCONNECTED:16,WEBIM_CONNCTION_AJAX_ERROR:17,WEBIM_CONNCTION_JOINROOM_ERROR:18,WEBIM_CONNCTION_GETROOM_ERROR:19,WEBIM_CONNCTION_GETROOMINFO_ERROR:20,WEBIM_CONNCTION_GETROOMMEMBER_ERROR:21,WEBIM_CONNCTION_GETROOMOCCUPANTS_ERROR:22,WEBIM_CONNCTION_LOAD_CHATROOM_ERROR:23,WEBIM_CONNCTION_NOT_SUPPORT_CHATROOM_ERROR:24,WEBIM_CONNCTION_JOINCHATROOM_ERROR:25,WEBIM_CONNCTION_QUITCHATROOM_ERROR:26,WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR:27,WEBIM_CONNCTION_TOKEN_NOT_ASSIGN_ERROR:28,WEBIM_CONNCTION_SESSIONID_NOT_ASSIGN_ERROR:29,WEBIM_CONNCTION_RID_NOT_ASSIGN_ERROR:30,WEBIM_CONNCTION_CALLBACK_INNER_ERROR:31,WEBIM_CONNCTION_CLIENT_OFFLINE:32,WEBIM_CONNCTION_CLIENT_LOGOUT:33,WEBIM_CONNCTION_CLIENT_TOO_MUCH_ERROR:34,WEBIM_CONNECTION_ACCEPT_INVITATION_FROM_GROUP:35,WEBIM_CONNECTION_DECLINE_INVITATION_FROM_GROUP:36,WEBIM_CONNECTION_ACCEPT_JOIN_GROUP:37,WEBIM_CONNECTION_DECLINE_JOIN_GROUP:38,WEBIM_CONNECTION_CLOSED:39,WEBIM_UPLOADFILE_BROWSER_ERROR:100,WEBIM_UPLOADFILE_ERROR:101,WEBIM_UPLOADFILE_NO_LOGIN:102,WEBIM_UPLOADFILE_NO_FILE:103,WEBIM_DOWNLOADFILE_ERROR:200,WEBIM_DOWNLOADFILE_NO_LOGIN:201,WEBIM_DOWNLOADFILE_BROWSER_ERROR:202,WEBIM_MESSAGE_REC_TEXT:300,WEBIM_MESSAGE_REC_TEXT_ERROR:301,WEBIM_MESSAGE_REC_EMOTION:302,WEBIM_MESSAGE_REC_PHOTO:303,WEBIM_MESSAGE_REC_AUDIO:304,WEBIM_MESSAGE_REC_AUDIO_FILE:305,WEBIM_MESSAGE_REC_VEDIO:306,WEBIM_MESSAGE_REC_VEDIO_FILE:307,WEBIM_MESSAGE_REC_FILE:308,WEBIM_MESSAGE_SED_TEXT:309,WEBIM_MESSAGE_SED_EMOTION:310,WEBIM_MESSAGE_SED_PHOTO:311,WEBIM_MESSAGE_SED_AUDIO:312,WEBIM_MESSAGE_SED_AUDIO_FILE:313,WEBIM_MESSAGE_SED_VEDIO:314,WEBIM_MESSAGE_SED_VEDIO_FILE:315,WEBIM_MESSAGE_SED_FILE:316,WEBIM_MESSAGE_SED_ERROR:317,STATUS_INIT:400,STATUS_DOLOGIN_USERGRID:401,STATUS_DOLOGIN_IM:402,STATUS_OPENED:403,STATUS_CLOSING:404,STATUS_CLOSED:405,STATUS_ERROR:406}}()},function(e,t,o){!function(){var e=function(){},n=o(2).code,r=10485760,i=function(){try{return new window.XMLHttpRequest}catch(e){return!1}},s=function(){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(e){return!1}},a=function(t){t=t||!0;var o=i()||s();if("withCredentials"in o)return o;if(!t)return o;if("undefined"==typeof window.XDomainRequest)return o;var n=new XDomainRequest;return n.readyState=0,n.status=100,n.onreadystatechange=e,n.onload=function(){n.readyState=4,n.status=200;var e=new ActiveXObject("Microsoft.XMLDOM");e.async="false",e.loadXML(n.responseText),n.responseXML=e,n.response=n.responseText,n.onreadystatechange()},n.ontimeout=n.onerror=function(){n.readyState=4,n.status=500,n.onreadystatechange()},n},c=function(){if("ActiveXObject"in window)try{return new ActiveXObject("ShockwaveFlash.ShockwaveFlash")}catch(e){return 0}else if(navigator.plugins&&navigator.plugins.length>0)return navigator.plugins["Shockwave Flash"];return 0}(),p=function(){var e=this,t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";this.encode=function(o){var n,r,i,s,a,c,p,l="",u=0;for(o=e._utf8_encode(o);u<o.length;)n=o.charCodeAt(u++),r=o.charCodeAt(u++),i=o.charCodeAt(u++),s=n>>2,a=(3&n)<<4|r>>4,c=(15&r)<<2|i>>6,p=63&i,isNaN(r)?c=p=64:isNaN(i)&&(p=64),l=l+t.charAt(s)+t.charAt(a)+t.charAt(c)+t.charAt(p);return l},this.decode=function(o){var n,r,i,s,a,c,p,l="",u=0;for(o=o.replace(/[^A-Za-z0-9\+\/\=]/g,"");u<o.length;)s=t.indexOf(o.charAt(u++)),a=t.indexOf(o.charAt(u++)),c=t.indexOf(o.charAt(u++)),p=t.indexOf(o.charAt(u++)),n=s<<2|a>>4,r=(15&a)<<4|c>>2,i=(3&c)<<6|p,l+=String.fromCharCode(n),64!=c&&(l+=String.fromCharCode(r)),64!=p&&(l+=String.fromCharCode(i));return l=e._utf8_decode(l)},this._utf8_encode=function(e){e=e.replace(/\r\n/g,"\n");for(var t="",o=0;o<e.length;o++){var n=e.charCodeAt(o);n<128?t+=String.fromCharCode(n):n>127&&n<2048?(t+=String.fromCharCode(n>>6|192),t+=String.fromCharCode(63&n|128)):(t+=String.fromCharCode(n>>12|224),t+=String.fromCharCode(n>>6&63|128),t+=String.fromCharCode(63&n|128))}return t},this._utf8_decode=function(e){for(var t="",o=0,n=0,r=0,i=0;o<e.length;)n=e.charCodeAt(o),n<128?(t+=String.fromCharCode(n),o++):n>191&&n<224?(r=e.charCodeAt(o+1),t+=String.fromCharCode((31&n)<<6|63&r),o+=2):(r=e.charCodeAt(o+1),i=e.charCodeAt(o+2),t+=String.fromCharCode((15&n)<<12|(63&r)<<6|63&i),o+=3);return t}},l=a(),u="undefined"!=typeof FormData,d="undefined"!=typeof Blob,m=l.setRequestHeader||!1,h=l.overrideMimeType||!1,f=m&&u,_=f||c,y=m&&(d||h);Object.keys||(Object.keys=function(){var e=Object.prototype.hasOwnProperty,t=!{toString:null}.propertyIsEnumerable("toString"),o=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],n=o.length;return function(r){if("object"!==("undefined"==typeof r?"undefined":_typeof(r))&&("function"!=typeof r||null===r))throw new TypeError("Object.keys called on non-object");var i,s,a=[];for(i in r)e.call(r,i)&&a.push(i);if(t)for(s=0;s<n;s++)e.call(r,o[s])&&a.push(o[s]);return a}}());var g={hasFormData:u,hasBlob:d,emptyfn:e,isCanSetRequestHeader:m,hasOverrideMimeType:h,isCanUploadFileAsync:f,isCanUploadFile:_,isCanDownLoadFile:y,isSupportWss:function(){var e=[/MQQBrowser[\/]5([.]\d+)?\sTBS/];if(!window.WebSocket)return!1;for(var t=window.navigator.userAgent,o=0,n=e.length;o<n;o++)if(e[o].test(t))return!1;return!0}(),getIEVersion:function(){var e,t=navigator.userAgent,o={4:8,5:9,6:10,7:11};return e=t.match(/MSIE (\d+)/i),e&&e[1]?+e[1]:(e=t.match(/Trident\/(\d+)/i),e&&e[1]?o[e[1]]||null:null)}(),stringify:function(e){if("undefined"!=typeof JSON&&JSON.stringify)return JSON.stringify(e);var t="",o=[],n=function e(n){var r=!1;"[object Array]"===Object.prototype.toString.call(n)?(o.push("]","["),r=!0):"[object Object]"===Object.prototype.toString.call(n)&&o.push("}","{");for(var i in n)"[object Null]"===Object.prototype.toString.call(n[i])?n[i]="null":"[object Undefined]"===Object.prototype.toString.call(n[i])&&(n[i]="undefined"),t+=n[i]&&"object"===_typeof(n[i])?","+(r?"":'"'+i+'":'+(r?'"':""))+e(n[i]):',"'+(r?"":i+'":"')+n[i]+'"';return""!=t&&(t=t.slice(1)),o.pop()+t+o.pop()};return n(e)},login:function(t){var t=t||{},o=t.success||e,r=t.error||e,i=t.appKey||"",s=i.split("#");if(2!==s.length)return r({type:n.WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR}),!1;var a=s[0],c=s[1],p=p||t.https,l=t.user||"",u=t.pwd||"",d=t.apiUrl,m={grant_type:"password",username:l,password:u,timestamp:+new Date},h=g.stringify(m),t={url:d+"/"+a+"/"+c+"/token",dataType:"json",data:h,success:o,error:r};return g.ajax(t)},getFileUrl:function(e){var t={url:"",filename:"",filetype:"",data:""},o="string"==typeof e?document.getElementById(e):e;if(!g.isCanUploadFileAsync||!o)return t;try{if(window.URL.createObjectURL){var n=o.files;if(n.length>0){var r=n.item(0);t.data=r,t.url=window.URL.createObjectURL(r),t.filename=r.name||""}}else{var r=document.getElementById(e).value;t.url=r;var i=r.lastIndexOf("/"),s=r.lastIndexOf("\\"),a=Math.max(i,s);a<0?t.filename=r:t.filename=r.substring(a+1)}var c=t.filename.lastIndexOf(".");return c!=-1&&(t.filetype=t.filename.substring(c+1).toLowerCase()),t}catch(e){throw e}},getFileSize:function(e){var t=0;if(e)if(e.files)e.files.length>0&&(t=e.files[0].size);else if(e.select&&"ActiveXObject"in window){e.select();var o=new ActiveXObject("Scripting.FileSystemObject"),e=o.GetFile(e.value);t=e.Size}if(console.log("fileSize: ",t),t>1e7)return!1;var n=Math.round(t/1e3);if(n<1e3)t=n+" KB";else if(n>=1e3){var r=n/1e3;if(r<1e3)t=r.toFixed(1)+" MB";else{var i=r/1e3;t=i.toFixed(1)+" GB"}}return t},hasFlash:c,trim:function(e){return e="string"==typeof e?e:"",e.trim?e.trim():e.replace(/^\s|\s$/g,"")},parseEmoji:function(e){if("undefined"==typeof WebIM.Emoji||"undefined"==typeof WebIM.Emoji.map)return e;var t=WebIM.Emoji;for(var o in t.map)if(t.map.hasOwnProperty(o))for(;e.indexOf(o)>-1;)e=e.replace(o,'<img class="emoji" src="'+t.path+t.map[o]+'" />');return e},parseLink:function(e){var t=/(https?\:\/\/|www\.)([a-zA-Z0-9-]+(\.[a-zA-Z0-9]+)+)(\:[0-9]{2,4})?\/?((\.[:_0-9a-zA-Z-]+)|[:_0-9a-zA-Z-]*\/?)*\??[:_#@*&%0-9a-zA-Z-\/=]*/gm;return e=e.replace(t,function(e){var t=/^https?/gm.test(e);return"<a href='"+(t?e:"//"+e)+"' target='_blank'>"+e+"</a>"})},parseJSON:function(e){if(window.JSON&&window.JSON.parse)return window.JSON.parse(e+"");var t,o=null,n=g.trim(e+"");return n&&!g.trim(n.replace(/(,)|(\[|{)|(}|])|"(?:[^"\\\r\n]|\\["\\\/bfnrt]|\\u[\da-fA-F]{4})*"\s*:?|true|false|null|-?(?!0\d)\d+(?:\.\d+|)(?:[eE][+-]?\d+|)/g,function(e,n,r,i){return t&&n&&(o=0),0===o?e:(t=r||n,o+=!i-!r,"")}))?Function("return "+n)():Function("Invalid JSON: "+e)()},parseUploadResponse:function(e){return e.indexOf("callback")>-1?e.slice(9,-1):e},parseDownloadResponse:function(e){return e&&e.type&&"application/json"===e.type||0>Object.prototype.toString.call(e).indexOf("Blob")?this.url+"?token=":window.URL.createObjectURL(e)},uploadFile:function(t){var t=t||{};t.onFileUploadProgress=t.onFileUploadProgress||e,t.onFileUploadComplete=t.onFileUploadComplete||e,t.onFileUploadError=t.onFileUploadError||e,t.onFileUploadCanceled=t.onFileUploadCanceled||e;var o=t.accessToken||this.context.accessToken;if(!o)return void t.onFileUploadError({type:n.WEBIM_UPLOADFILE_NO_LOGIN,id:t.id});var i,s,a,c=t.appKey||this.context.appKey||"";if(c&&(a=c.split("#"),i=a[0],s=a[1]),!i&&!s)return void t.onFileUploadError({type:n.WEBIM_UPLOADFILE_ERROR,id:t.id});var p=t.apiUrl,l=p+"/"+i+"/"+s+"/chatfiles";if(!g.isCanUploadFileAsync)return void(g.hasFlash&&"function"==typeof t.flashUpload?t.flashUpload&&t.flashUpload(l,t):t.onFileUploadError({type:n.WEBIM_UPLOADFILE_BROWSER_ERROR,id:t.id}));var u=t.file.data?t.file.data.size:void 0;if(u>r)return void t.onFileUploadError({type:n.WEBIM_UPLOADFILE_ERROR,id:t.id});if(u<=0)return void t.onFileUploadError({type:n.WEBIM_UPLOADFILE_ERROR,id:t.id});var d=g.xmlrequest(),m=function(e){t.onFileUploadError({type:n.WEBIM_UPLOADFILE_ERROR,id:t.id,xhr:d})};d.upload&&d.upload.addEventListener("progress",t.onFileUploadProgress,!1),d.addEventListener?(d.addEventListener("abort",t.onFileUploadCanceled,!1),d.addEventListener("load",function(e){try{var o=g.parseJSON(d.responseText);try{t.onFileUploadComplete(o)}catch(e){t.onFileUploadError({type:n.WEBIM_CONNCTION_CALLBACK_INNER_ERROR,data:e})}}catch(e){t.onFileUploadError({type:n.WEBIM_UPLOADFILE_ERROR,data:d.responseText,id:t.id,xhr:d})}},!1),d.addEventListener("error",m,!1)):d.onreadystatechange&&(d.onreadystatechange=function(){if(4===d.readyState)if(200===ajax.status)try{var e=g.parseJSON(d.responseText);t.onFileUploadComplete(e)}catch(e){t.onFileUploadError({type:n.WEBIM_UPLOADFILE_ERROR,data:d.responseText,id:t.id,xhr:d})}else t.onFileUploadError({type:n.WEBIM_UPLOADFILE_ERROR,data:d.responseText,id:t.id,xhr:d});else d.abort(),t.onFileUploadCanceled()}),d.open("POST",l),d.setRequestHeader("restrict-access","true"),d.setRequestHeader("Accept","*/*"),d.setRequestHeader("Authorization","Bearer "+o);var h=new FormData;h.append("file",t.file.data),d.send(h)},download:function(t){t.onFileDownloadComplete=t.onFileDownloadComplete||e,t.onFileDownloadError=t.onFileDownloadError||e;var o=t.accessToken||this.context.accessToken;if(!o)return void t.onFileDownloadError({type:n.WEBIM_DOWNLOADFILE_NO_LOGIN,id:t.id});var r=function(e){t.onFileDownloadError({type:n.WEBIM_DOWNLOADFILE_ERROR,id:t.id,xhr:i})};if(!g.isCanDownLoadFile)return void t.onFileDownloadComplete();var i=g.xmlrequest();"addEventListener"in i?(i.addEventListener("load",function(e){t.onFileDownloadComplete(i.response,i)},!1),i.addEventListener("error",r,!1)):"onreadystatechange"in i&&(i.onreadystatechange=function(){4===i.readyState?200===ajax.status?t.onFileDownloadComplete(i.response,i):t.onFileDownloadError({type:n.WEBIM_DOWNLOADFILE_ERROR,id:t.id,xhr:i}):(i.abort(),t.onFileDownloadError({type:n.WEBIM_DOWNLOADFILE_ERROR,id:t.id,xhr:i}))});var s=t.method||"GET",a=t.responseType||"blob",c=t.mimeType||"text/plain; charset=x-user-defined";i.open(s,t.url),"undefined"!=typeof Blob?i.responseType=a:i.overrideMimeType(c);var p={"X-Requested-With":"XMLHttpRequest",Accept:"application/octet-stream","share-secret":t.secret,Authorization:"Bearer "+o},l=t.headers||{};for(var u in l)p[u]=l[u];for(var u in p)p[u]&&i.setRequestHeader(u,p[u]);i.send(null)},parseTextMessage:function(e,t){if("string"==typeof e){if("[object Object]"!==Object.prototype.toString.call(t))return{isemoji:!1,body:[{type:"txt",data:e}]};var o=e,n=[],r=/\[[^[\]]{2,3}\]/gm,i=o.match(r);if(!i||i.length<1)return{isemoji:!1,body:[{type:"txt",data:e}]};for(var s=!1,a=0;a<i.length;a++){var c=o.substring(0,o.indexOf(i[a])),p=WebIM.Emoji.map[i[a]];if(c&&n.push({type:"txt",data:c}),p){var l=WebIM.Emoji.map?WebIM.Emoji.path+p:null;l?(s=!0,n.push({type:"emoji",data:l})):n.push({type:"txt",data:i[a]});var u=o.indexOf(i[a])+i[a].length;o=o.substring(u)}else n.push({type:"txt",data:i[a]})}return o&&n.push({type:"txt",data:o}),s?{isemoji:s,body:n}:{isemoji:!1,body:[{type:"txt",data:e}]}}},xmlrequest:a,getXmlFirstChild:function(e,t){var o=e.getElementsByTagName(t);return 0==o.length?null:o[0]},ajax:function(t){var o=t.dataType||"text",r=t.success||e,i=t.error||e,s=g.xmlrequest();s.onreadystatechange=function(){if(4===s.readyState){var e=s.status||0;if(200===e){try{switch(o){case"text":return void r(s.responseText);case"json":var t=g.parseJSON(s.responseText);return void r(t,s);case"xml":return void(s.responseXML&&s.responseXML.documentElement?r(s.responseXML.documentElement,s):i({type:n.WEBIM_CONNCTION_AJAX_ERROR,data:s.responseText}))}r(s.response||s.responseText,s)}catch(e){i({type:n.WEBIM_CONNCTION_AJAX_ERROR,data:e})}return}return void i({type:n.WEBIM_CONNCTION_AJAX_ERROR,data:s.responseText})}0===s.readyState&&i({type:n.WEBIM_CONNCTION_AJAX_ERROR,data:s.responseText})},t.responseType&&s.responseType&&(s.responseType=t.responseType),t.mimeType&&g.hasOverrideMimeType&&s.overrideMimeType(t.mimeType);var a=t.type||"POST",c=t.data||null,p="";if("get"===a.toLowerCase()&&c){for(var l in c)c.hasOwnProperty(l)&&(p+=l+"="+c[l]+"&");p=p?p.slice(0,-1):p,t.url+=(t.url.indexOf("?")>0?"&":"?")+(p?p+"&":p)+"_v="+(new Date).getTime(),c=null,p=null}if(s.open(a,t.url),g.isCanSetRequestHeader){var u=t.headers||{};for(var d in u)u.hasOwnProperty(d)&&s.setRequestHeader(d,u[d])}return s.send(c),s},ts:function(){var e=new Date,t=e.getHours(),o=e.getMinutes(),n=e.getSeconds(),r=e.getMilliseconds();return(t<10?"0"+t:t)+":"+(o<10?"0"+o:o)+":"+(n<10?"0"+n:n)+":"+r+" "},getObjectKey:function(e,t){for(var o in e)if(e[o]==t)return o;return""},sprintf:function(){var e,t,o=arguments,n=o[0]||"";for(e=1,t=o.length;e<t;e++)n=n.replace(/%s/,o[e]);return n},encrypt:function e(t){var o=new p,e=o.encode(t);return e},decrypt:function e(t){var o=new p,e=o.decode(t);return e=escape(e),e=e.replace(/%00/g,""),e=unescape(e)},setCookie:function(e,t,o){var n=e+"="+encodeURIComponent(t);"number"==typeof o&&(n+="; max-age: "+60*o*60*24),document.cookie=n},getCookie:function(){var e={},t=document.cookie;if(""===t)return e;for(var o=t.split("; "),n=0;n<o.length;n++){var r=o[n],i=r.indexOf("="),s=r.substring(0,i),a=r.substring(i+1);a=decodeURIComponent(a),e[s]=a}return e}};t.utils=g}()},function(e,t,o){!function(){var e=o(3).utils,n=function e(t,o){return!this instanceof e?new e(t):(this._msg={},"function"==typeof e[t]&&(e[t].prototype.setGroup=this.setGroup,this._msg=new e[t](o)),this._msg)};n.prototype.setGroup=function(e){this.body.group=e},n.txt=function(e){this.id=e,this.type="txt",this.body={}},n.txt.prototype.set=function(e){this.value=e.msg,this.body={id:this.id,to:e.to,msg:this.value,type:this.type,roomType:e.roomType,ext:e.ext||{},success:e.success,fail:e.fail},!e.roomType&&delete this.body.roomType},n.cmd=function(e){this.id=e,this.type="cmd",this.body={}},n.cmd.prototype.set=function(e){this.value="",this.body={to:e.to,action:e.action,msg:this.value,type:this.type,roomType:e.roomType,ext:e.ext||{},success:e.success},!e.roomType&&delete this.body.roomType},n.location=function(e){this.id=e,this.type="loc",this.body={}},n.location.prototype.set=function(e){this.body={to:e.to,type:this.type,roomType:e.roomType,addr:e.addr,lat:e.lat,lng:e.lng,ext:e.ext||{}}},n.img=function(e){this.id=e,this.type="img",this.body={}},n.img.prototype.set=function(t){t.file=t.file||e.getFileUrl(t.fileInputId),this.value=t.file,this.body={id:this.id,file:this.value,apiUrl:t.apiUrl,to:t.to,type:this.type,ext:t.ext||{},roomType:t.roomType,onFileUploadError:t.onFileUploadError,onFileUploadComplete:t.onFileUploadComplete,success:t.success,fail:t.fail,flashUpload:t.flashUpload,width:t.width,height:t.height,body:t.body,uploadError:t.uploadError,uploadComplete:t.uploadComplete},!t.roomType&&delete this.body.roomType},n.audio=function(e){this.id=e,this.type="audio",this.body={}},n.audio.prototype.set=function(t){t.file=t.file||e.getFileUrl(t.fileInputId),this.value=t.file,this.filename=t.filename||this.value.filename,this.body={
id:this.id,file:this.value,filename:this.filename,apiUrl:t.apiUrl,to:t.to,type:this.type,ext:t.ext||{},length:t.length||0,roomType:t.roomType,file_length:t.file_length,onFileUploadError:t.onFileUploadError,onFileUploadComplete:t.onFileUploadComplete,success:t.success,fail:t.fail,flashUpload:t.flashUpload,body:t.body},!t.roomType&&delete this.body.roomType},n.file=function(e){this.id=e,this.type="file",this.body={}},n.file.prototype.set=function(t){t.file=t.file||e.getFileUrl(t.fileInputId),this.value=t.file,this.filename=t.filename||this.value.filename,this.body={id:this.id,file:this.value,filename:this.filename,apiUrl:t.apiUrl,to:t.to,type:this.type,ext:t.ext||{},roomType:t.roomType,onFileUploadError:t.onFileUploadError,onFileUploadComplete:t.onFileUploadComplete,success:t.success,fail:t.fail,flashUpload:t.flashUpload,body:t.body},!t.roomType&&delete this.body.roomType},n.video=function(e){},n.video.prototype.set=function(e){};var r=function e(t){return!this instanceof e?new e(t,conn):void(this.msg=t)};r.prototype.send=function(t){var o=this,n=function(o){o.ext=o.ext||{},o.ext.weichat=o.ext.weichat||{},o.ext.weichat.originType=o.ext.weichat.originType||"webim";var n={from:t.context.userId||"",to:o.to,bodies:[o.body],ext:o.ext||{}},r=e.stringify(n),i=$msg({type:o.group||"chat",to:o.toJid,id:o.id,xmlns:"jabber:client"}).c("body").t(r);o.roomType&&i.up().c("roomtype",{xmlns:"easemob:x:roomtype",type:"chatroom"}),setTimeout(function(){"undefined"!=typeof _msgHash&&_msgHash[o.id]&&_msgHash[o.id].msg.fail instanceof Function&&_msgHash[o.id].msg.fail(o.id)},6e4),t.sendCommand(i.tree(),o.id)};if(o.msg.file){if(o.msg.body&&o.msg.body.url)return void n(o.msg);var r=o.msg.onFileUploadComplete,i=function(e){if(e.entities[0]["file-metadata"]){var i=e.entities[0]["file-metadata"]["content-length"];o.msg.file_length=i,o.msg.filetype=e.entities[0]["file-metadata"]["content-type"],i>204800&&(o.msg.thumbnail=!0)}o.msg.body={type:o.msg.type||"file",url:("https:"!=location.protocol&&t.isHttpDNS?t.apiUrl+e.uri.substr(e.uri.indexOf("/",9)):e.uri)+"/"+e.entities[0].uuid,secret:e.entities[0]["share-secret"],filename:o.msg.file.filename||o.msg.filename,size:{width:o.msg.width||0,height:o.msg.height||0},length:o.msg.length||0,file_length:o.msg.file_length||0,filetype:o.msg.filetype},n(o.msg),r instanceof Function&&r(e,o.msg.id)};o.msg.onFileUploadComplete=i,e.uploadFile.call(t,o.msg)}else o.msg.body={type:"chat"===o.msg.type?"txt":o.msg.type,msg:o.msg.msg},"cmd"===o.msg.type?o.msg.body.action=o.msg.action:"loc"===o.msg.type&&(o.msg.body.addr=o.msg.addr,o.msg.body.lat=o.msg.lat,o.msg.body.lng=o.msg.lng),n(o.msg)},t._msg=r,t.message=n}()},function(e,t){!function(){function e(e){this.array=void 0===e?[]:new Array(e)}e.prototype={length:function(){return this.array.length},at:function(e){return this.array[e]},set:function(e,t){this.array[e]=t},push:function(e){return this.array.push(e)},slice:function(e,t){return this.array=this.array.slice(e,t)},concat:function(e){this.array=this.array.concat(e)},remove:function(e,t){t=void 0===t?1:t,this.array.splice(e,t)},join:function(e){return this.array.join(e)},clear:function(){this.array.length=0}};var o=function(){this._array_h=new e};o.prototype={_index:0,push:function(e){this._array_h.push(e)},pop:function(){var e=null;return this._array_h.length()&&(e=this._array_h.at(this._index),2*++this._index>=this._array_h.length()&&(this._array_h.slice(this._index),this._index=0)),e},head:function(){var e=null,t=this._array_h.length();return t&&(e=this._array_h.at(t-1)),e},tail:function(){var e=null,t=this._array_h.length();return t&&(e=this._array_h.at(this._index)),e},length:function(){return this._array_h.length()-this._index},empty:function(){return 0===this._array_h.length()},clear:function(){this._array_h.clear()}},t.Queue=o}()}])});
//# sourceMappingURL=websdk-1.4.10.min.js.map
